# Tournament System - Kana Backend

## Overview

This tournament system provides a comprehensive backend for managing competitive quiz tournaments with AI-generated questions from Kana. It supports bracket-style tournaments similar to Champions League format, where users face each other in elimination rounds.

**ðŸ”¥ FULLY FUNCTIONAL WITH MYSQL DATABASE INTEGRATION ðŸ”¥**

## Features

### Core Tournament Features
- **Tournament Creation**: Anyone can create tournaments with customizable settings
- **Bracket Generation**: Automatic single/double elimination bracket creation
- **AI Question Generation**: 7-15 questions per match generated by Kana AI
- **Real-time Scoring**: Automatic scoring and winner determination
- **Prize Distribution**: Configurable prize pools and distribution
- **MySQL Database**: Persistent storage with proper foreign key relationships
- **User Profiles**: Track player statistics and tournament history

### Tournament Settings
- **Bracket Types**: Single elimination, Double elimination
- **Player Limits**: 4, 8, 16, 32, or 64 players
- **Question Count**: 7-15 questions per match
- **Time Limits**: Configurable match time limits (default 30 minutes)
- **Difficulty Levels**: Easy, Medium, Hard
- **Subject Categories**: Mathematics, Science, History, Literature, General, etc.
- **Custom Topics**: Users can specify custom topics for question generation

### Match System
- **Automatic Bracket Advancement**: Winners automatically advance to next round
- **Tie-breaker Rules**: Faster completion time wins in case of score ties
- **Question Expiration**: Questions expire after time limit to prevent cheating
- **Score Calculation**: Percentage-based scoring with detailed feedback

## Database Setup

### Prerequisites
1. Install MySQL Server on your system
2. Create a database named `brainink`
3. Configure environment variables in `.env` file

### Environment Variables
```bash
# Database Configuration
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_mysql_password
DB_NAME=brainink

# Google AI API Key
GOOGLE_API_KEY=your_google_api_key
```

### Database Schema
The system will automatically create the following tables on startup:
- `tournaments` - Main tournament information
- `tournament_participants` - Player registrations
- `tournament_brackets` - Bracket structures
- `tournament_matches` - Individual matches
- `tournament_questions` - AI-generated questions
- `tournament_submissions` - Player answers and scores
- `user_profiles` - Player statistics and history

### Manual Setup (Optional)
If you want to manually create the database schema, run the SQL commands in:
- `tournament_schema.sql` - Complete schema with foreign keys
- `tournament_schema_clean.sql` - Alternative schema version

## API Endpoints

### Tournament Management

#### Create Tournament
```
POST /api/tournaments/create
```
**Body:**
```json
{
  "name": "Tournament Name",
  "description": "Tournament description",
  "creator_address": "0x...",
  "max_players": 8,
  "entry_fee": 10,
  "prize_pool": 100,
  "bracket_type": "single_elimination",
  "questions_per_match": 10,
  "time_limit_minutes": 30,
  "difficulty_level": "medium",
  "subject_category": "mathematics",
  "custom_topics": ["Algebra", "Geometry"],
  "is_public": true,
  "prize_distribution": [60, 30, 10]
}
```

#### Join Tournament
```
POST /api/tournaments/:tournamentId/join
```
**Body:**
```json
{
  "user_address": "0x..."
}
```

#### Start Tournament
```
POST /api/tournaments/:tournamentId/start
```
**Body:**
```json
{
  "creator_address": "0x..."
}
```

#### Get Tournament Details
```
GET /api/tournaments/:tournamentId
```

#### Get All Tournaments
```
GET /api/tournaments?page=1&limit=10&status=registration&search=math
```

### Match Management

#### Generate Questions for Match
```
POST /api/tournaments/:tournamentId/matches/:matchId/generate-questions
```

#### Submit Match Answers
```
POST /api/tournaments/:tournamentId/matches/:matchId/submit
```
**Body:**
```json
{
  "user_address": "0x...",
  "answers": [0, 2, 1, 3, 0, 1, 2, 3, 0, 1],
  "completion_time_ms": 45000
}
```

## Database Schema

The system uses the following tables:

- **tournaments**: Main tournament information
- **tournament_participants**: Track who joined each tournament
- **tournament_brackets**: Store bracket structure and match data
- **tournament_matches**: Individual match details
- **tournament_questions**: Generated questions for each match
- **tournament_submissions**: User answers and scores
- **user_profiles**: User statistics and XP tracking

## Integration with Frontend

### Arena Hub Integration

The tournament system integrates with the existing Arena Hub component through:

1. **Tournament Creation Modal**: Users can create tournaments with all customization options
2. **Tournament List**: Display active, completed, and user's tournaments
3. **Live Tournament View**: Real-time bracket visualization and match participation
4. **Question Interface**: Seamless integration with quiz components for match participation

### Kana AI Integration

Questions are generated using the existing Kana AI system:

1. **Dynamic Generation**: Questions generated on-demand for each match
2. **Topic Awareness**: Uses tournament subject and custom topics
3. **Difficulty Scaling**: Adjusts question difficulty based on tournament settings
4. **Fallback System**: Provides backup questions if AI generation fails

## Database Connection

To connect to your existing tournament database, update the database configuration in the environment variables:

```
DB_HOST=your_database_host
DB_USER=your_database_user
DB_PASSWORD=your_database_password
DB_NAME=your_database_name
```

## Getting Started

1. **Install Dependencies**:
   ```bash
   npm install uuid mysql2
   ```

2. **Set Up Database**:
   - Run the SQL schema from `tournament_schema_clean.sql`
   - Update database connection settings in `.env`

3. **Start Server**:
   ```bash
   npm start
   ```

4. **Test Endpoints**:
   - Server runs on port 10000
   - Test with: `http://localhost:10000/api/tournaments`

## Tournament Flow

1. **Registration Phase**:
   - Creator creates tournament with settings
   - Users join until max capacity or registration deadline
   - Creator starts tournament when ready

2. **Bracket Generation**:
   - System automatically generates elimination bracket
   - First round matches are marked as "ready"
   - Subsequent rounds wait for previous round completion

3. **Match Execution**:
   - Questions generated on-demand for each match
   - Both players answer within time limit
   - System calculates scores and determines winner
   - Winner advances to next round

4. **Tournament Completion**:
   - Final match determines tournament winner
   - Prize distribution (if applicable)
   - Tournament statistics updated

## Future Enhancements

- [ ] Real-time spectator mode
- [ ] Tournament streaming/replay system
- [ ] Advanced analytics and statistics
- [ ] Team tournaments (squad vs squad)
- [ ] Integration with blockchain for prize distribution
- [ ] Tournament templates and presets
- [ ] Advanced matchmaking algorithms
